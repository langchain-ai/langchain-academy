# Filtering and trimming messages

## Review

これまでに以下の項目について深く理解してきました:

* グラフ状態スキーマのカスタマイズ方法
* カスタム状態レデューサーの定義方法
* 複数のグラフ状態スキーマの使用方法

## Goals

これからはLangGraphでモデルを使用してこれらの概念を実践していきます!

今後のセッションでは、長期的な記憶を持つチャットボットを構築していきます。

チャットボットはメッセージを使用するため、まずグラフ状態でメッセージを扱う高度な方法について説明します。

## Messages as state

まず、いくつかのメッセージを定義してみましょう。

[コード例]

リマインドとして、これらをチャットモデルに渡すことができます。

[コード例]

MessagesStateを使って、シンプルなグラフでチャットモデルを実行できます。

## Reducer 

メッセージを使用する際の実践的な課題は、長時間の会話を管理することです。

メッセージのリストが大きくなるにつれて、モデルに渡すトークン数が増えるため、注意が必要です。

これに対処するいくつかの方法があります。

まず、RemoveMessageと add_messagesレデューサーを使用するテクニックを思い出してください。

[コード例]

## Filtering messages

グラフ状態を変更する必要がない場合は、チャットモデルに渡すメッセージをフィルタリングするだけでよい場合があります。

例えば、フィルタリングされたリストをモデルに渡すだけでよい場合: `llm.invoke(messages[-1:])`

## Trim messages

もう1つのアプローチは、指定したトークン数に基づいてメッセージをトリミングすることです。

これにより、メッセージ履歴を指定されたトークン数に制限します。

フィルタリングがエージェント間のメッセージのサブセットを事後的に返すのに対し、トリミングはチャットモデルが応答に使用できるトークン数を制限します。

以下の`trim_messages`を参照してください。
